{"componentChunkName":"component---src-templates-blog-post-js","path":"/blogger/java-xor-swap-performance/","result":{"data":{"site":{"siteMetadata":{"title":"Coding with Thomas"}},"markdownRemark":{"id":"17ac235e-f4ed-5968-b37b-f3f6a70ba821","excerpt":"Hey, just quick post, because I was working to polish my min heap and checked about different swap techniques. From my experience I know there are two different…","html":"<p>Hey,<br>\njust quick post, because I was working to polish my min heap and checked about different swap techniques.</p>\n<p>From my experience I know there are two different versions to swap two integers in an array.</p>\n<ol>\n<li>XOR swap algorithm</li>\n<li>Swap using temporary variable</li>\n</ol>\n<p>Since swapping is used pretty much everywhere, I decided to micro benchmark these against each other using <a href=\"http://code.google.com/p/caliper/\">Caliper</a>.</p>\n<p>I’ve seen many people using the XOR algorithm lately, I don’t know if they know that this is inefficient. Many people seem to do not care about this, because bitshifting makes them kinda look cool probably? However, here is my code so we can sort out the performance of both pretty easy:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SwapBenchmark</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">SimpleBenchmark</span> <span class=\"token punctuation\">{</span>  \n  \n  <span class=\"token annotation punctuation\">@Param</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token string\">\"10\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"100\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"1000\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"10000\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"100000\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"1000000\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"10000000\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"100000000\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>  \n  <span class=\"token keyword\">private</span> <span class=\"token keyword\">int</span> size<span class=\"token punctuation\">;</span>  \n  \n  <span class=\"token annotation punctuation\">@Param</span>  \n  <span class=\"token class-name\">SwapType</span> type<span class=\"token punctuation\">;</span>  \n  \n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">enum</span> <span class=\"token class-name\">SwapType</span> <span class=\"token punctuation\">{</span>  \n    <span class=\"token constant\">XOR</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">TMP</span>  \n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>  \n  \n  <span class=\"token keyword\">int</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> array<span class=\"token punctuation\">;</span>  \n  \n  <span class=\"token annotation punctuation\">@Override</span>  \n  <span class=\"token keyword\">protected</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setUp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">{</span>  \n    array <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">[</span>size<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token class-name\">Random</span> r <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> size<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n      array<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> r<span class=\"token punctuation\">.</span><span class=\"token function\">nextInt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">}</span>  \n  <span class=\"token punctuation\">}</span>  \n  \n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">timeSwap</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> reps<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> rep <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> rep <span class=\"token operator\">&lt;</span> reps<span class=\"token punctuation\">;</span> rep<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n      <span class=\"token keyword\">int</span> sum <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>  \n      <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> size<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> x <span class=\"token operator\">=</span> i<span class=\"token punctuation\">;</span>  \n        <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> y <span class=\"token operator\">=</span> size <span class=\"token operator\">-</span> i <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>type <span class=\"token operator\">==</span> <span class=\"token class-name\">SwapType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">XOR</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n          array<span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">]</span> <span class=\"token operator\">^=</span> array<span class=\"token punctuation\">[</span>y<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>  \n          array<span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">]</span> <span class=\"token operator\">^=</span> <span class=\"token punctuation\">(</span>array<span class=\"token punctuation\">[</span>y<span class=\"token punctuation\">]</span> <span class=\"token operator\">^=</span> array<span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n          sum <span class=\"token operator\">+=</span> i<span class=\"token punctuation\">;</span>  \n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>  \n          <span class=\"token keyword\">int</span> tmpIndex <span class=\"token operator\">=</span> array<span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>  \n          array<span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> array<span class=\"token punctuation\">[</span>y<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>  \n          array<span class=\"token punctuation\">[</span>y<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> tmpIndex<span class=\"token punctuation\">;</span>  \n          sum <span class=\"token operator\">+=</span> i<span class=\"token punctuation\">;</span>  \n        <span class=\"token punctuation\">}</span>  \n      <span class=\"token punctuation\">}</span>  \n      <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>sum<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">}</span>  \n  \n  <span class=\"token punctuation\">}</span>  \n  \n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n    <span class=\"token class-name\">Runner</span><span class=\"token punctuation\">.</span><span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SwapBenchmark</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  <span class=\"token punctuation\">}</span>  \n<span class=\"token punctuation\">}</span>  \n</code></pre></div>\n<p>So basically I’m swapping n-times in an n-size array, where n ranges from ten to 100,000,000 which is really big.</p>\n<p>The result isn’t very exciting, I used my Nehalem i7 with 3,3GHZ and latest Java7u7:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">      size type        us linear runtime  \n       10  XOR      2,90 =  \n       10  TMP      2,84 =  \n      100  XOR      3,06 =  \n      100  TMP      2,85 =  \n     1000  XOR      3,92 =  \n     1000  TMP      3,52 =  \n    10000  XOR     20,21 =  \n    10000  TMP     14,22 =  \n   100000  XOR    183,33 =  \n   100000  TMP    118,57 =  \n  1000000  XOR   1822,98 =  \n  1000000  TMP   1192,19 =  \n 10000000  XOR  19401,65 ==  \n 10000000  TMP  13266,78 ==  \n100000000  XOR 194173,73 ==============================  \n100000000  TMP 134364,67 ====================  \n  \n</code></pre></div>\n<p>The TMP swap is much more efficient in every case. Why is this?<br>\n<a href=\"http://en.wikipedia.org/wiki/XOR_swap_algorithm\">Wikipedia states the following:</a></p>\n<blockquote>\n<p>On modern CPU architectures, the XOR technique is considerably slower than using a temporary variable to do swapping. One reason is that modern CPUs strive to execute instructions in parallel via <a href=\"http://en.wikipedia.org/wiki/Instruction_pipeline\" title=\"Instruction pipeline\">instruction pipelines</a>. In the XOR technique, the inputs to each operation depend on the results of the previous operation, so they must be executed in strictly sequential order. If efficiency is of tremendous concern, it is advised to test the speeds of both the XOR technique and temporary variable swapping on the target architecture.</p>\n</blockquote>\n<p>There is actually nothing more to add. <strong>So please don’t do any pre-mature optimization!</strong><br>\nEven if it looks cool to do a bit-shifting trick ;)</p>","frontmatter":{"title":"Java XOR Swap Performance","date":"6th October 2012","description":null},"tableOfContents":"","timeToRead":2},"previous":{"fields":{"slug":"/blogger/particle-swarm-optimization/"},"frontmatter":{"title":"Particle Swarm Optimization"}},"next":{"fields":{"slug":"/blogger/building-news-aggregation-engine/"},"frontmatter":{"title":"Building a news aggregation engine"}}},"pageContext":{"id":"17ac235e-f4ed-5968-b37b-f3f6a70ba821","previousPostId":"4accb054-cb8a-5575-8023-950669495bb5","nextPostId":"2a03381a-99fa-5a2a-bc5e-5ab5afe0b058"}},"staticQueryHashes":["2270107033","2841359383"],"slicesMap":{}}