{"componentChunkName":"component---src-templates-blog-post-js","path":"/blogger/k-means-clustering-with-mapreduce/","result":{"data":{"site":{"siteMetadata":{"title":"Coding with Thomas"}},"markdownRemark":{"id":"7d5e20d0-c2ec-56f7-b244-43bfe0f2e7b0","excerpt":"Hi all, just finished the MapReduce side implementation of k-Means clustering. Notice that this is a series that contains this post and a follow-up one which…","html":"<p>Hi all,</p>\n<p>just finished the MapReduce side implementation of k-Means clustering. Notice that this is a series that contains this post and a follow-up one which implements the same algorithm using BSP and Apache Hama.</p>\n<p>Note that this is just an example to explain you k-means clustering and <em>how</em> it can be easily solved and implemented with MapReduce.<br>\nIf you want to use a more generic version of k-means, you should head over to <a href=\"http://mahout.apache.org/\">Apache Mahout</a>. Mahout provides k-means clustering and other fancy things on top of Hadoop MapReduce. <strong>This code is also not thought for production usage, you can cluster quite small datasets from 300m to 10g very well with it, for lager sets please take the Mahout implementation.</strong></p>\n<p><strong>The clustering itself</strong></p>\n<p>We need some vectors (which dimension doesn’t matter, hopefully they have all the same dimension). These vectors representing our data, and then we need k-centers. These centers are vectors too, sometimes they are just a subset of the input vectors, but sometimes they are random points or points-of-interest to which we are going to cluster them.</p>\n<p>Since this is a MapReduce version I tell you what keys and values we are using. This is really simple, because we are just using a vector, a vector can be a clustercenter as well. So we treat our clustercenter-vectors always like keys, and the input vectors are simple values.</p>\n<p>The clustering itself works like this then:</p>\n<ul>\n<li>In the map step</li>\n<li>Read the cluster centers into memory from a sequencefile</li>\n<li>Iterate over each cluster center for each input key/value pair. </li>\n<li>Measure the distances and save the nearest center which has the lowest distance to the vector</li>\n<li>Write the clustercenter with its vector to the filesystem.</li>\n</ul>\n<blockquote>\n</blockquote>\n<ul>\n<li>In the reduce step (we get associated vectors for each center)</li>\n<li>Iterate over each value vector and calculate the average vector. (Sum each vector and devide each part by the number of vectors we received).</li>\n<li>This is the new center, save it into a SequenceFile.</li>\n<li>Check the convergence between the clustercenter that is stored in the key object and the new center.</li>\n<li>If it they are not equal, increment an update counter</li>\n</ul>\n<blockquote>\n</blockquote>\n<ul>\n<li>Run this whole thing until nothing was updated anymore.</li>\n</ul>\n<p>Pretty easy, isn’t it?:D</p>\n<p><strong>Model</strong></p>\n<p>Let’s have a look at the involved models:</p>\n<p>Vector class:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Vector</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">WritableComparable</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Vector</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>  \n  \n <span class=\"token keyword\">private</span> <span class=\"token keyword\">double</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> vector<span class=\"token punctuation\">;</span>  \n  \n <span class=\"token keyword\">public</span> <span class=\"token class-name\">Vector</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n  <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n <span class=\"token punctuation\">}</span>  \n  \n <span class=\"token keyword\">public</span> <span class=\"token class-name\">Vector</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Vector</span> v<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n  <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  <span class=\"token keyword\">int</span> l <span class=\"token operator\">=</span> v<span class=\"token punctuation\">.</span>vector<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span>  \n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>vector <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token keyword\">double</span><span class=\"token punctuation\">[</span>l<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>  \n  <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span><span class=\"token function\">arraycopy</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">.</span>vector<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>vector<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> l<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n <span class=\"token punctuation\">}</span>  \n  \n <span class=\"token keyword\">public</span> <span class=\"token class-name\">Vector</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span> x<span class=\"token punctuation\">,</span> <span class=\"token keyword\">double</span> y<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n  <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>vector <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token keyword\">double</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">{</span> x<span class=\"token punctuation\">,</span> y <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>  \n <span class=\"token punctuation\">}</span>  \n  \n <span class=\"token annotation punctuation\">@Override</span>  \n <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">write</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">DataOutput</span> out<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span> <span class=\"token punctuation\">{</span>  \n  out<span class=\"token punctuation\">.</span><span class=\"token function\">writeInt</span><span class=\"token punctuation\">(</span>vector<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> vector<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span>  \n   out<span class=\"token punctuation\">.</span><span class=\"token function\">writeDouble</span><span class=\"token punctuation\">(</span>vector<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n <span class=\"token punctuation\">}</span>  \n  \n <span class=\"token annotation punctuation\">@Override</span>  \n <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">readFields</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">DataInput</span> in<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span> <span class=\"token punctuation\">{</span>  \n  <span class=\"token keyword\">int</span> size <span class=\"token operator\">=</span> in<span class=\"token punctuation\">.</span><span class=\"token function\">readInt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  vector <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token keyword\">double</span><span class=\"token punctuation\">[</span>size<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>  \n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> size<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span>  \n   vector<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> in<span class=\"token punctuation\">.</span><span class=\"token function\">readDouble</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n <span class=\"token punctuation\">}</span>  \n  \n <span class=\"token annotation punctuation\">@Override</span>  \n <span class=\"token keyword\">public</span> <span class=\"token keyword\">int</span> <span class=\"token function\">compareTo</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Vector</span> o<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n  \n  <span class=\"token keyword\">boolean</span> equals <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>  \n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> vector<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n     <span class=\"token keyword\">int</span> c <span class=\"token operator\">=</span> vector<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">-</span> o<span class=\"token punctuation\">.</span>vector<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>  \n     <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>c <span class=\"token operator\">!=</span> <span class=\"token number\">0.0d</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n     <span class=\"token keyword\">return</span> c<span class=\"token punctuation\">;</span>  \n  <span class=\"token punctuation\">}</span>  \n  <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>  \n <span class=\"token punctuation\">}</span>  \n   <span class=\"token comment\">// get and set omitted  </span>\n  \n<span class=\"token punctuation\">}</span>  </code></pre></div>\n<p>You see everything is pretty standard. The <em>compareTo</em> method is just checking equality, just because we don’t need an inner ordering- but we want the same keys to get in the same chunk. Be aware that we are returning 1 if they are not equal. Hadoop’s quicksort is only swapping the element if it is greater than the other one. &#x3C;- This is a great tip ;)</p>\n<p>If you are not sure aware about this hack, please reimplement this correctly.</p>\n<p>The cluster center is basically just an “has-a-vector” class that just delegates the read/write/compareTo method to the vector. It is just devided so we can exactly differ between a center and a vector, altough it is the same.</p>\n<p><strong>The distance measurement</strong></p>\n<p>I’ve spoken in the algorithm-description about a distance measuring. But I left this open. Let’s declare some things:</p>\n<p>We need a measurement of a distance between two vectors, especially between a center and a vector.<br>\nI’ve came up with the manhattan distance because it doesn’t require much computation overhead like square-rooting (Euclidian distance) and it is not too complex.<br>\nLet’s have a look:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">double</span> <span class=\"token function\">measureDistance</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ClusterCenter</span> center<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Vector</span> v<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n  <span class=\"token keyword\">double</span> sum <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>  \n  <span class=\"token keyword\">int</span> length <span class=\"token operator\">=</span> v<span class=\"token punctuation\">.</span><span class=\"token function\">getVector</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span>  \n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n   sum <span class=\"token operator\">+=</span> <span class=\"token class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token function\">abs</span><span class=\"token punctuation\">(</span>center<span class=\"token punctuation\">.</span><span class=\"token function\">getCenter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getVector</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>  \n     <span class=\"token operator\">-</span> v<span class=\"token punctuation\">.</span><span class=\"token function\">getVector</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  <span class=\"token punctuation\">}</span>  \n  \n  <span class=\"token keyword\">return</span> sum<span class=\"token punctuation\">;</span>  \n <span class=\"token punctuation\">}</span>  \n  </code></pre></div>\n<p>As you can see, just a sum of each part of the vectors difference. So easy!!! Let’s head to the map implementation…</p>\n<p><strong>The Mapper</strong></p>\n<p>Let’s assume that there is a list or a list-like sequencefile-iterating interface that is called centers. It contains ClusterCenter objects that represent the current centers. The DistanceMeasurer class contains the static method we defined in the last part.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">// setup and cleanup stuffz omitted  </span>\n<span class=\"token annotation punctuation\">@Override</span>  \n <span class=\"token keyword\">protected</span> <span class=\"token keyword\">void</span> <span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ClusterCenter</span> key<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Vector</span> value<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Context</span> context<span class=\"token punctuation\">)</span>  \n   <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span>  \n  \n  <span class=\"token class-name\">ClusterCenter</span> nearest <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>  \n  <span class=\"token keyword\">double</span> nearestDistance <span class=\"token operator\">=</span> <span class=\"token class-name\">Double</span><span class=\"token punctuation\">.</span><span class=\"token constant\">MAX</span>\\_VALUE<span class=\"token punctuation\">;</span>  \n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">ClusterCenter</span> c <span class=\"token operator\">:</span> centers<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n   <span class=\"token keyword\">double</span> dist <span class=\"token operator\">=</span> <span class=\"token class-name\">DistanceMeasurer</span><span class=\"token punctuation\">.</span><span class=\"token function\">measureDistance</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n   <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nearest <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n    nearest <span class=\"token operator\">=</span> c<span class=\"token punctuation\">;</span>  \n    nearestDistance <span class=\"token operator\">=</span> dist<span class=\"token punctuation\">;</span>  \n   <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>  \n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nearestDistance <span class=\"token operator\">></span> dist<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n     nearest <span class=\"token operator\">=</span> c<span class=\"token punctuation\">;</span>  \n     nearestDistance <span class=\"token operator\">=</span> dist<span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">}</span>  \n   <span class=\"token punctuation\">}</span>  \n  <span class=\"token punctuation\">}</span>  \n  context<span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span>nearest<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n <span class=\"token punctuation\">}</span></code></pre></div>\n<p>Like told in the introduction, it’s just a looping and a measuring. Always keeping a reference to the nearest center. Afterwards we are writing it out.</p>\n<p><strong>The Reducer</strong></p>\n<p>Once again let’s have a list or a list-like sequencefile-iterating interface that is called centers. Here we need it for storage reasons.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">// setup and cleanup stuffz omitted once again  </span>\n<span class=\"token annotation punctuation\">@Override</span>  \n <span class=\"token keyword\">protected</span> <span class=\"token keyword\">void</span> <span class=\"token function\">reduce</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ClusterCenter</span> key<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Iterable</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Vector</span><span class=\"token punctuation\">></span></span> values<span class=\"token punctuation\">,</span>  \n   <span class=\"token class-name\">Context</span> context<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span>  \n  \n  <span class=\"token class-name\">Vector</span> newCenter <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Vector</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Vector</span><span class=\"token punctuation\">></span></span> vectorList <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">LinkedList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Vector</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  <span class=\"token keyword\">int</span> vectorSize <span class=\"token operator\">=</span> key<span class=\"token punctuation\">.</span><span class=\"token function\">getCenter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getVector</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span>  \n  newCenter<span class=\"token punctuation\">.</span><span class=\"token function\">setVector</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token keyword\">double</span><span class=\"token punctuation\">[</span>vectorSize<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Vector</span> value <span class=\"token operator\">:</span> values<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n   vectorList<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Vector</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n   <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> value<span class=\"token punctuation\">.</span><span class=\"token function\">getVector</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n    newCenter<span class=\"token punctuation\">.</span><span class=\"token function\">getVector</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">+=</span> value<span class=\"token punctuation\">.</span><span class=\"token function\">getVector</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>  \n   <span class=\"token punctuation\">}</span>  \n  <span class=\"token punctuation\">}</span>  \n  \n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> newCenter<span class=\"token punctuation\">.</span><span class=\"token function\">getVector</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n   newCenter<span class=\"token punctuation\">.</span><span class=\"token function\">getVector</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> newCenter<span class=\"token punctuation\">.</span><span class=\"token function\">getVector</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>  \n     <span class=\"token operator\">/</span> vectorList<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  <span class=\"token punctuation\">}</span>  \n  \n  <span class=\"token class-name\">ClusterCenter</span> center <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ClusterCenter</span><span class=\"token punctuation\">(</span>newCenter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  centers<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>center<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Vector</span> vector <span class=\"token operator\">:</span> vectorList<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n   context<span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span>center<span class=\"token punctuation\">,</span> vector<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  <span class=\"token punctuation\">}</span>  \n  \n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>center<span class=\"token punctuation\">.</span><span class=\"token function\">converged</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  \n   context<span class=\"token punctuation\">.</span><span class=\"token function\">getCounter</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Counter</span><span class=\"token punctuation\">.</span><span class=\"token constant\">CONVERGED</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">increment</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n <span class=\"token punctuation\">}</span>  \n  \n</code></pre></div>\n<p>So sorry, but this got a bit more bulky than I initially thought it could be. Let me explain: The first loop only dumps the values in the iterable into a list and sums up each component of the vector in a newly created center. Then we are averaging it in another loop and we are writing the new center along with each vector we held in memory the whole time. Afterwards we are just checking if the vector has changed, this method is just a delegating to the underlying vectors compareTo. If the centers are not equal it returns true. And therefore it updates an counter. Actually the name of the counter is misleading, it should be named “updated”. If you are now asking how we are controlling the recursion part, head over here and look how it should work: <a href=\"http://codingwiththomas.blogspot.com/2011/04/controlling-hadoop-job-recursion.html\">Controlling Hadoop MapReduce recursion</a>.</p>\n<p><strong>Example</strong></p>\n<p>I don’t want anyone to leave without a working example ;) SO here is our 2-dimensional input: k-Centers:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">(1,1);(5,5)  \n\n```Input vectors:  \nVector [vector=[16.0, 3.0]]  \nVector [vector=[7.0, 6.0]]  \nVector [vector=[6.0, 5.0]]  \nVector [vector=[25.0, 1.0]]  \nVector [vector=[1.0, 2.0]]  \nVector [vector=[3.0, 3.0]]  \nVector [vector=[2.0, 2.0]]  \nVector [vector=[2.0, 3.0]]  \nVector [vector=[-1.0, -23.0]]  \n</code></pre></div>\n<p>Now the jobs getting scheduled over and over again and the output looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">ClusterCenter [center=Vector [vector=[13.5, 3.75]]] / Vector [vector=[16.0, 3.0]]  \nClusterCenter [center=Vector [vector=[13.5, 3.75]]] / Vector [vector=[7.0, 6.0]]  \nClusterCenter [center=Vector [vector=[13.5, 3.75]]] / Vector [vector=[6.0, 5.0]]  \nClusterCenter [center=Vector [vector=[13.5, 3.75]]] / Vector [vector=[25.0, 1.0]]  \nClusterCenter [center=Vector [vector=[1.4, -2.6]]] / Vector [vector=[1.0, 2.0]]  \nClusterCenter [center=Vector [vector=[1.4, -2.6]]] / Vector [vector=[3.0, 3.0]]  \nClusterCenter [center=Vector [vector=[1.4, -2.6]]] / Vector [vector=[2.0, 2.0]]  \nClusterCenter [center=Vector [vector=[1.4, -2.6]]] / Vector [vector=[2.0, 3.0]]  \nClusterCenter [center=Vector [vector=[1.4, -2.6]]] / Vector [vector=[-1.0, -23.0]]</code></pre></div>\n<p>So we see that the two initial centers were moved to (1.4,-2.6) and to (13.5,3.75). Cool thing :D</p>\n<p>Here is the code:<br>\n<a href=\"https://github.com/thomasjungblut/mapreduce-kmeans\">https://github.com/thomasjungblut/mapreduce-kmeans</a></p>\n<p>The code is located in the <em>de.jungblut.clustering.mapreduce</em> package, if you click run on the KMeansClusteringJob the example data is getting loaded and you can step through the code if you are interested. If you want to run it on your cluster, I assume that you’re using 2.2, if not, then you have to take care of the up/downgrade for yourself.</p>\n<p><strong>Note</strong> that if you are submitting this to a real cluster files like _logs or _SUCCESS may be in the directory of your job. This will break the outputter at the end of the Job.<br>\nEither remove the files or modify the method.<br>\nAlso note that if you run this with a large file, the number of reducers should be set to 1, otherwise there will be file collisions (See the reducer’s cleanup method). This can be done better, but I’ll leave this to you ;)</p>\n<p>Thank you very much.</p>","frontmatter":{"title":"k-Means Clustering with MapReduce","date":"25th May 2011","description":null},"tableOfContents":"","timeToRead":6},"previous":{"fields":{"slug":"/blogger/series-k-means-clustering-mapreduce-bsp/"},"frontmatter":{"title":"Series: K-Means Clustering (MapReduce | BSP)"}},"next":{"fields":{"slug":"/blogger/set-intersection-and-difference-with/"},"frontmatter":{"title":"Set-intersection and -difference with Hadoop"}}},"pageContext":{"id":"7d5e20d0-c2ec-56f7-b244-43bfe0f2e7b0","previousPostId":"9bb0e9d1-863b-5384-a5d9-a104dd15a5b3","nextPostId":"cc847453-c74b-58b5-98f9-0dbac40293f9"}},"staticQueryHashes":["2270107033","2841359383"],"slicesMap":{}}