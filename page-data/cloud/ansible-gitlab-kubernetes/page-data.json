{"componentChunkName":"component---src-templates-blog-post-js","path":"/cloud/ansible-gitlab-kubernetes/","result":{"data":{"site":{"siteMetadata":{"title":"Coding with Thomas"}},"markdownRemark":{"id":"dda666db-802d-5733-80cd-fafe8e9812cc","excerpt":"Hey there, I wanted to quickly share an automation step that you might want to find useful in your Ansible Playbooks.\nIt’s about adding a Kubernetes cluster to…","html":"<p>Hey there,</p>\n<p>I wanted to quickly share an automation step that you might want to find useful in your Ansible Playbooks.\nIt’s about adding a Kubernetes cluster to a Gitlab instance (eg installed via Omnibus) using Ansible.</p>\n<p><a href=\"https://docs.gitlab.com/ee/user/project/clusters/add_remove_clusters.html#existing-kubernetes-cluster\">The documentation tells you about a lot of manual steps</a> to do it, but one can also do it via the API and a couple of shell scripts in Ansible.</p>\n<h2 id=\"prerequisites\" style=\"position:relative;\"><a href=\"#prerequisites\" aria-label=\"prerequisites permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Prerequisites</h2>\n<p>You need only two things:</p>\n<ul>\n<li><code class=\"language-text\">kubectl</code> should be installed and ready to talk with the Kubernetes cluster you want to integrate</li>\n<li>the Gitlab API should be available under a valid domain name, although localhost:port would also work</li>\n</ul>\n<h2 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h2>\n<p>Effectively it’s a four step process:</p>\n<ol>\n<li>add a new admin token to the instance (can be skipped if already exists)</li>\n<li>adding the service account and cluster role bindings to the K8s cluster</li>\n<li>retrieve the k8s api url, certificate and token</li>\n<li>register using the gitlab API</li>\n</ol>\n<h2 id=\"ansible-script\" style=\"position:relative;\"><a href=\"#ansible-script\" aria-label=\"ansible script permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Ansible Script</h2>\n<p>Before we start, it needs two files to run: namely <code class=\"language-text\">gitlab-admin-service-account.yaml</code> and <code class=\"language-text\">gitlab_add_k8s.j2</code> template.</p>\n<p>The first looks like that, but can <a href=\"https://docs.gitlab.com/ee/user/project/clusters/add_remove_clusters.html#existing-kubernetes-cluster\">ultimately come from the documentation</a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ServiceAccount\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> gitlab\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> kube<span class=\"token punctuation\">-</span>system\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> rbac.authorization.k8s.io/v1beta1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ClusterRoleBinding\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> gitlab<span class=\"token punctuation\">-</span>admin\n<span class=\"token key atrule\">roleRef</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">apiGroup</span><span class=\"token punctuation\">:</span> rbac.authorization.k8s.io\n  <span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ClusterRole\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> cluster<span class=\"token punctuation\">-</span>admin\n<span class=\"token key atrule\">subjects</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ServiceAccount\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> gitlab\n    <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> kube<span class=\"token punctuation\">-</span>system</code></pre></div>\n<p>The latter just encodes the REST request body, which is akin to what is documented in the <a href=\"https://docs.gitlab.com/ee/api/project_clusters.html#add-existing-cluster-to-project\">API documentation</a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"cluster-name\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"platform_kubernetes_attributes\"</span><span class=\"token operator\">:</span><span class=\"token punctuation\">{</span>\n       <span class=\"token property\">\"api_url\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"{{k8s_api_url.stdout}}\"</span><span class=\"token punctuation\">,</span> \n       <span class=\"token property\">\"token\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"{{k8s_gitlab_token.stdout}}\"</span><span class=\"token punctuation\">,</span>\n       <span class=\"token property\">\"ca_cert\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"{{k8s_cert.stdout}}\"</span>\n    <span class=\"token punctuation\">}</span>\n <span class=\"token punctuation\">}</span></code></pre></div>\n<p>Here’s the full script:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> integrate gitlab with kubernetes\n  <span class=\"token key atrule\">hosts</span><span class=\"token punctuation\">:</span> all\n  <span class=\"token key atrule\">become</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n  <span class=\"token key atrule\">vars</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">gitlab_admin_token</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'SUPER_SeCuRE_P4SSWORD_1237'</span>\n    <span class=\"token key atrule\">gitlab_url</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"https://{{ gitlab_domain }}\"</span>\n  <span class=\"token key atrule\">tasks</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> install railties\n      <span class=\"token key atrule\">apt</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">pkg</span><span class=\"token punctuation\">:</span> ruby<span class=\"token punctuation\">-</span>railties\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> add admin token\n      <span class=\"token key atrule\">become</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n      <span class=\"token key atrule\">shell</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          echo \"token = User.find_by_username('root').personal_access_tokens.create(scopes: [:api, :sudo], name: 'Automation token'); token.set_token('{{ gitlab_admin_token }}'); token.save!\" | gitlab-rails console --environment=production</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> store k8s api url\n      <span class=\"token key atrule\">shell</span><span class=\"token punctuation\">:</span> kubectl config view <span class=\"token punctuation\">-</span>o jsonpath='<span class=\"token punctuation\">{</span>.clusters<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>.cluster.server<span class=\"token punctuation\">}</span>'\n      <span class=\"token key atrule\">register</span><span class=\"token punctuation\">:</span> k8s_api_url\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> add service account\n      <span class=\"token key atrule\">shell</span><span class=\"token punctuation\">:</span> kubectl apply <span class=\"token punctuation\">-</span>f gitlab<span class=\"token punctuation\">-</span>admin<span class=\"token punctuation\">-</span>service<span class=\"token punctuation\">-</span>account.yaml\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> set token secret\n      <span class=\"token key atrule\">shell</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n        SECRET_NAME=$(kubectl -n kube-system get secret -o name | grep gitlab)\n        kubectl -n kube-system get ${SECRET_NAME} -o jsonpath=\"{['data']['token']}\" | base64 -d</span>\n      <span class=\"token key atrule\">register</span><span class=\"token punctuation\">:</span> k8s_gitlab_token\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> store k8s certificate\n      <span class=\"token key atrule\">shell</span><span class=\"token punctuation\">:</span> kubectl get secrets <span class=\"token punctuation\">-</span>o=name <span class=\"token punctuation\">|</span> xargs kubectl get <span class=\"token punctuation\">-</span>o jsonpath=\"<span class=\"token punctuation\">{</span><span class=\"token punctuation\">[</span><span class=\"token string\">'data'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'ca\\.crt'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span>\" <span class=\"token punctuation\">|</span> base64 <span class=\"token punctuation\">-</span>d <span class=\"token punctuation\">|</span> sed <span class=\"token punctuation\">-</span>E '<span class=\"token punctuation\">:</span>a;N;$<span class=\"token tag\">!ba;s/</span>\\r<span class=\"token punctuation\">{</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">}</span>\\n/\\\\n/g'\n      <span class=\"token key atrule\">register</span><span class=\"token punctuation\">:</span> k8s_cert\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> add k8s cluster to gitlab\n      <span class=\"token key atrule\">uri</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">url</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"{{gitlab_url}}/api/v4/admin/clusters/add\"</span>\n        <span class=\"token key atrule\">method</span><span class=\"token punctuation\">:</span> POST\n        <span class=\"token key atrule\">body_format</span><span class=\"token punctuation\">:</span> json\n        <span class=\"token key atrule\">return_content</span><span class=\"token punctuation\">:</span> yes\n        <span class=\"token key atrule\">status_code</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">201</span><span class=\"token punctuation\">]</span>\n        <span class=\"token key atrule\">headers</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">Private-Token</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"{{ gitlab_admin_token }}\"</span>\n          <span class=\"token key atrule\">Accept</span><span class=\"token punctuation\">:</span> application/json\n          <span class=\"token key atrule\">Content-Type</span><span class=\"token punctuation\">:</span> application/json\n        <span class=\"token key atrule\">body</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"{{ lookup('template', './gitlab_add_k8s.j2') }}\"</span></code></pre></div>\n<p>The most notable aspect is really how to set the token, let’s take a look at the script with proper Ruby formatting:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\">token <span class=\"token operator\">=</span> User<span class=\"token punctuation\">.</span>find_by_username<span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">'root'</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>personal_access_tokens<span class=\"token punctuation\">.</span>create<span class=\"token punctuation\">(</span><span class=\"token symbol\">scopes</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token symbol\">:api</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">:sudo</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">name</span><span class=\"token operator\">:</span> <span class=\"token string-literal\"><span class=\"token string\">'Automation token'</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \ntoken<span class=\"token punctuation\">.</span>set_token<span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">'{{ gitlab_admin_token }}'</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \ntoken<span class=\"token punctuation\">.</span>save<span class=\"token operator\">!</span></code></pre></div>\n<p>The whole thing you just pipe into the gitlab-rails console <code class=\"language-text\">gitlab-rails console --environment=production</code> to persist it in the database.</p>\n<h2 id=\"bonus-localhost-clusters\" style=\"position:relative;\"><a href=\"#bonus-localhost-clusters\" aria-label=\"bonus localhost clusters permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Bonus: Localhost clusters</h2>\n<p>If you find yourself having the cluster running on the same host as the gitlab instance (eg for development purposes) you might find yourself hitting that error:</p>\n<blockquote>\n<p>gitlab Import url is blocked: “Requests to the local network are not allowed”</p>\n</blockquote>\n<p>This is somewhat explained in this <a href=\"https://gitlab.com/gitlab-org/gitlab/-/issues/26845\">GitLab issue</a>, the TL;DR; is that it’s a security feature.</p>\n<p>You can turn it off however, using the admin token we created above the Ansible script basically just becomes:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> allow localhost communication\n    <span class=\"token key atrule\">uri</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">url</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"{{gitlab_url}}/api/v4/application/settings?allow_local_requests_from_hooks_and_services=true\"</span>\n    <span class=\"token key atrule\">headers</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">Private-Token</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"{{ gitlab_admin_token }}\"</span>\n    <span class=\"token key atrule\">method</span><span class=\"token punctuation\">:</span> PUT</code></pre></div>\n<p>Hope it helps!</p>\n<p>Cheers,<br>\nThomas</p>","frontmatter":{"title":"Adding Kubernetes Clusters to GitLab Instances using Ansible","date":"16th November 2020","description":null},"tableOfContents":"<ul>\n<li><a href=\"#prerequisites\">Prerequisites</a></li>\n<li><a href=\"#overview\">Overview</a></li>\n<li><a href=\"#ansible-script\">Ansible Script</a></li>\n<li><a href=\"#bonus-localhost-clusters\">Bonus: Localhost clusters</a></li>\n</ul>","timeToRead":3},"previous":{"fields":{"slug":"/open-source/apache-hama-why-it-didnt-become-successful/"},"frontmatter":{"title":"Apache Hama - why it didn't become successful"}},"next":{"fields":{"slug":"/random/fixing-black-screen-fan-100/"},"frontmatter":{"title":"Fixing Black Screen with fan running at 100% using a Nvidia GPU"}}},"pageContext":{"id":"dda666db-802d-5733-80cd-fafe8e9812cc","previousPostId":"2c3e180e-bc27-5fd6-b496-e98470552c5c","nextPostId":"9c5c521e-84be-5179-aa89-e7e65138e3bc"}},"staticQueryHashes":["2270107033","2841359383"],"slicesMap":{}}