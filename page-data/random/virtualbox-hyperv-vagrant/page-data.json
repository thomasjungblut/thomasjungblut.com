{"componentChunkName":"component---src-templates-blog-post-js","path":"/random/virtualbox-hyperv-vagrant/","result":{"data":{"site":{"siteMetadata":{"title":"Coding with Thomas"}},"markdownRemark":{"id":"f4e6cc4f-8a7a-5f46-b3dc-dc1665110c18","excerpt":"I have been trying to get Docker, VirtualBox, WSL 2 working at the same time with Vagrant. Working at the same time means that they run in parallel and work…","html":"<p>I have been trying to get <a href=\"docker.com\">Docker</a>, <a href=\"http://virtualbox.org/\">VirtualBox</a>, <a href=\"https://en.wikipedia.org/wiki/Windows_Subsystem_for_Linux#WSL_2\">WSL 2</a> working at the same time with <a href=\"https://www.vagrantup.com/\">Vagrant</a>. Working at the same time means that they run in parallel and work individually - so I’m not trying to run Docker on WSL2 to talk with something inside a VirtualBox spun-up by Vagrant.</p>\n<p>The scenario is mostly around being able to use WSL2 and Docker on the Windows 10 host machine while you provision VMs (preferably with VirtualBox) provisioned via Vagrant.<br>\nThis issue took me a couple of hours to figure out and I wanted to share a bit of the steps and issues I’ve seen.</p>\n<blockquote>\n<p>TL;DR; there is no ultimate fix for this issue, but a workaround</p>\n</blockquote>\n<h2 id=\"the-setup\" style=\"position:relative;\"><a href=\"#the-setup\" aria-label=\"the setup permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The Setup</h2>\n<p>I’m running on Win10, 19041 Build (May 2020 Update) and I have virtualization enabled in my BIOS. On top I’m running Docker (v19) with native WSL2 integration, coming from the Docker Desktop Application. The Docker Daemon is also exposed locally, so I can easily access it from my WSL2 running Ubuntu. All of these things run on top of, or through Hyper-V.</p>\n<p>Hyper-V is installed and enabled at boot time - more on that later.</p>\n<p>To make it more complicated I’m using Vagrant (2.2.10) and VirtualBox (6.1) to run some Ansible playbooks.</p>\n<h2 id=\"my-virtualbox-vm-does-not-boot\" style=\"position:relative;\"><a href=\"#my-virtualbox-vm-does-not-boot\" aria-label=\"my virtualbox vm does not boot permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>My VirtualBox VM does not boot…</h2>\n<p>Testing some simple Vagrant box like that:</p>\n<div class=\"gatsby-highlight\" data-language=\"vagrant\"><pre class=\"language-vagrant\"><code class=\"language-vagrant\">Vagrant.configure(&quot;2&quot;) do |config|\n  config.vm.box = &quot;ubuntu/bionic64&quot;\nend</code></pre></div>\n<p><strong>Will hang forever trying to create a VM in VirtualBox.</strong></p>\n<p>Hold-on: we have Hyper-V installed, why isn’t Vagrant picking that as the default provider? The image doesn’t exist for Hyper-V and forcing it with <code class=\"language-text\">--provider hyperv</code> will tell you that it can only run with admin permissions. So it will fallback by default to <code class=\"language-text\">virtualbox</code> - <strong>sigh</strong>.</p>\n<p>Anyways, you will see a screen like this and without any particular error message in virtualbox and its system logs:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8edfa5309e9ba76fff870e770c687221/c67d4/vbox_hangs.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.32911392405063%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABj0lEQVR42m2SR5bCQAxEmxwMmBwMxmQbFvAIDy7A/a8k+DXTMyxYyJJb3aUqSW65XNrpdLLn82m3280ul4v89Xq1+/2u3Hq9tv1+LzscDrbb7Wy73cqyLFN+NpvZZDIxV61WbTAY6GIcxzYajWQkh8OhcvhWq2XNZtO63a51Oh1ZEARWr9etUqlYLpfTv+MD+uPxsMVioWrj8dhWq5UlSSIfRZGVSiVzzunhNyMHEUcFHiARCbAEEHBss9nYfD4Xy3a7Lab4RqNhtVpNrIgBRI3jEOTj8ShgpAI6nU7lYYgCcsTkKcg7gJFbLBb/AanIBQDxXKIASazX64md72m/31ffYIUPw1CsMRQ5mguD8/ksDwhnAADmgTEewehbL/8YUgUgvx6sBKuUpqnWhBi5sIdVuVzWgPBILRQKkp/P53/WJvxtMFKgz1rABJbI5wwjZgB+OP4foxh3GKoL3mD8xO9J+oZD3ffx858isCUGmL0kZoDcQY1jJaI3EA1l7zDOaANTJsb7mMefZ34r8LTtBZfpFT0P2uQ7AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"virtualbox vm hangs\"\n        title=\"\"\n        src=\"/static/8edfa5309e9ba76fff870e770c687221/f058b/vbox_hangs.png\"\n        srcset=\"/static/8edfa5309e9ba76fff870e770c687221/c26ae/vbox_hangs.png 158w,\n/static/8edfa5309e9ba76fff870e770c687221/6bdcf/vbox_hangs.png 315w,\n/static/8edfa5309e9ba76fff870e770c687221/f058b/vbox_hangs.png 630w,\n/static/8edfa5309e9ba76fff870e770c687221/c67d4/vbox_hangs.png 723w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Good luck searching the internet for that kind of issue.</p>\n<h2 id=\"the-workaround\" style=\"position:relative;\"><a href=\"#the-workaround\" aria-label=\"the workaround permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The Workaround</h2>\n<p>Everything hinges on a very small flag, take an elevated CMD or power shell and run:</p>\n<div class=\"gatsby-highlight\" data-language=\"batch\"><pre class=\"language-batch\"><code class=\"language-batch\"><span class=\"token command\"><span class=\"token keyword\">bcdedit</span></span></code></pre></div>\n<p>Under “Windows Boot Loader” at the bottom, you should see this:</p>\n<div class=\"gatsby-highlight\" data-language=\"batch\"><pre class=\"language-batch\"><code class=\"language-batch\"><span class=\"token command\"><span class=\"token keyword\">hypervisorlaunchtype</span>    Auto</span></code></pre></div>\n<p>This is exactly what is <a href=\"https://docs.docker.com/docker-for-windows/troubleshoot/#virtualization\">required to run Docker on Windows</a>. So it might actually come from the Docker installer, when you decided to install it after your VirtualBox.</p>\n<p>To fix it, you simply have to turn it off:</p>\n<div class=\"gatsby-highlight\" data-language=\"batch\"><pre class=\"language-batch\"><code class=\"language-batch\"><span class=\"token command\"><span class=\"token keyword\">bcdedit</span> <span class=\"token parameter attr-name\">/set</span> hypervisorlaunchtype off</span></code></pre></div>\n<p>and <strong>reboot</strong>. Now Vagrant and VirtualBox should work again. The WSL2 will also continue to work.</p>\n<p>The big implication is that docker will stop working here though. It is quite vocal about it during startup and will link you to the above troubleshooting guide.</p>\n<p>How do you reverse this again? Just set the same variable to <code class=\"language-text\">auto</code> and <strong>reboot</strong>:</p>\n<div class=\"gatsby-highlight\" data-language=\"batch\"><pre class=\"language-batch\"><code class=\"language-batch\"><span class=\"token command\"><span class=\"token keyword\">bcdedit</span> <span class=\"token parameter attr-name\">/set</span> hypervisorlaunchtype auto</span></code></pre></div>\n<p>Same implications, but in reverse: VirtualBox can’t run VMs anymore, but Docker will continue to work. The reboot makes it a bit hard to automate, but in theory you can wrap those in batch scripts.</p>\n<h2 id=\"cant-i-just-uninstall-hyper-v\" style=\"position:relative;\"><a href=\"#cant-i-just-uninstall-hyper-v\" aria-label=\"cant i just uninstall hyper v permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Can’t I just uninstall Hyper-V?</h2>\n<p>Yes you can, but it turns out that un-installation via Windows features will not eliminate the above boot flags. Especially if you still have WSL2 running, there are some left-overs that can’t be disabled by any other means than <code class=\"language-text\">bcdedit</code>.</p>\n<p>Hope it helped!</p>\n<p>Cheers,\nThomas</p>","frontmatter":{"title":"VirtualBox, Vagrant, WSL2 and Docker on Windows 10","date":"8th November 2020","description":null},"tableOfContents":"<ul>\n<li><a href=\"#the-setup\">The Setup</a></li>\n<li><a href=\"#my-virtualbox-vm-does-not-boot\">My VirtualBox VM does not boot…</a></li>\n<li><a href=\"#the-workaround\">The Workaround</a></li>\n<li><a href=\"#cant-i-just-uninstall-hyper-v\">Can’t I just uninstall Hyper-V?</a></li>\n</ul>","timeToRead":2},"previous":{"fields":{"slug":"/graph/mincut/mincut/"},"frontmatter":{"title":"Minimum Cut - Stoer–Wagner algorithm"}},"next":{"fields":{"slug":"/random/fixing-braava-m6/"},"frontmatter":{"title":"Fixing Braava M6 not coming out of its home base"}}},"pageContext":{"id":"f4e6cc4f-8a7a-5f46-b3dc-dc1665110c18","previousPostId":"f2920e83-517d-5f8d-8b3a-b66adb1c3a78","nextPostId":"9e4e5108-1f85-5e6a-b552-184eaf7264f1"}},"staticQueryHashes":["2270107033","2841359383"],"slicesMap":{}}